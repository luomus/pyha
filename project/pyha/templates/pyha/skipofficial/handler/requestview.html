{% extends "pyha/base/requestview_base.html" %}
{% load i18n %}

{% block page_content %}
	<div class="tab-content">
		<div class="request-view-pane tab-pane {% if next == 'decision' %} active {% endif %}" role="tabpanel" id="decision">
			<h3>{% trans "handler_decision_window" %}</h3>
			<p>{% trans "handler_decision_window_description" %}</p>
			{% if collections %}
			<h4>{% trans "handler_secured_collection_decicions" %}</h4>
			<form action="{% url 'pyha:group_answer' %}" id="requestform" method="post">
				<table class="table" style="width:100%">
					<tr style=color:black>
						<th>{% trans "handler_collection_name" %}</th>
						<th></th>
						<th>{% trans "handler_collection_description" %}</th>
						<th>{% trans "handler_state_of_processing" %}</th>
						<th>{% trans "handler_decision_arguments" %}</th>
						<th style="text-align: center;">{% trans "handler_select" %}</th>
						<th>{% trans "handler_make_decision" %}</th>
					</tr>
					{% for collection in collections %}
						{% if collection.status == 1 %}
						<tr class="info clickable-row">
						{% elif collection.status == 3 %}
						<tr class="danger clickable-row">
						{% elif collection.status == 4 %}
						<tr class="success clickable-row">
						{% else %}
						<tr>
						{% endif %}
							<td>{{collection.result.collectionName}}</td>
							<td><small>[<a href="{{tun_link}}{{collection.address}}" target="_blank">{% trans 'to_metadata' %}</a>]</small></td>
							<td>{{collection.result.description}}</td>

							{% if collection.status == 1 %}
								{% if collection.address in handles %}
								<td>{% trans "handler_waiting_for_you" %}</td>
								{% else %}
								<td>{% trans "handler_waiting_for_others" %}</td>
								{% endif %}
							{% elif collection.status == 3 %}
							<td>{% trans "handler_denied" %}</td>
							{% elif collection.status == 2 %}
							<td>{% trans "handler_partially_accepted" %}</td>
							{% elif collection.status == 4 %}
							<td>{% trans "handler_accepted" %}</td>
							{% else %}
							<td>{% trans "handler_unknown" %}</td>
							{% endif %}
							<td>{% if collection.decisionExplanation %}<p>{{collection.decisionExplanation}}</p>{% else %}{% endif %}</td>
							<td>
								{% if collection.address in handles %}
								<p style="text-align: center;"><input {% if frozen or collection.status != 1 %} disabled {% endif %} onChange="" type="checkbox" name="collection_id_{{ collection.id }}" value="{{ collection.address }}" style="vertical-align: middle;"></p>
								{% else %}
								<p style="text-align: center;">{% trans "handler_not_handling" %}</p>
								{% endif %}
							</td>
							{% if forloop.first %}
								<td rowspan="{{collections|length}}" style="background-color:white; border-bottom:0px;">
									<h5>{% trans "handler_decision_arguments" %}</h5>
									<span>{% trans "handler_select_checksboxes_to_apply_this_decision_to" %}</span>
									<div class="form-group">
										<input type="hidden" id="requestid" name="requestid" value={{userRequest.id}}>
										<input type="hidden" id="next" name="next" value="{{request.path}}?next=decision">
										<textarea class="form-control" rows="5" cols="700" id="reason" name="reason"></textarea>
										<p style="margin:2px;">{% trans "handler_arguments_will_be_applied_to_all_selected" %}</p>
										<button type="submit" id="submit" name="answer" value=1 class="btn btn-success btn-sm" {% if userRequest.frozen %} disabled {% endif %}>{% trans "handler_accept" %}</button>
										<button type="submit" id="submit" name="answer" value=0 class="btn btn-danger btn-sm" {% if userRequest.frozen %} disabled {% endif %}>{% trans "handler_refuse" %}</button>
									</div>
								</td>
							{% endif %}
						</tr>
					{% endfor %}
				</table>
				{% csrf_token %}
			</form>
			{% endif %}
		</div>
		<div class="request-view-pane tab-pane {% if next == 'information' %} active {% endif %}" role="tabpanel" id="additional_information">
			<h3>{% trans "handler_additional_information_window" %}</h3>
			<p>{% trans "handler_additional_information_window_description" %}</p>
			{% for question in requestInformationChat_list %}
				{% if question.question %}
				<div class="panel panel-default" {% if question.user == user %} style="background-color:#d9edf7;" {% endif %}>
				<div class="panel-body"><p>{{question.date|date:"d.m.Y H:i"}} {{ question.name }} {% if question.target == 'sens' %} ({% trans 'sensitivity' %}) {% elif question.target == 'admin' %} ({% trans 'admin_question' %}) {% else %} ({{ question.result.collectionName }}) {% endif %} {% trans "handler_asked" %}&#10;&#13;{{question.message}}</p></div>
				</div>
				{% endif %}
				{% if question.question != True %}
				<div class="panel panel-default" {% if question.user == user %} style="background-color:#d9edf7;" {% endif %}>
				<div class="panel-body"><p>{{question.date|date:"d.m.Y H:i"}} {{ question.name }} {% trans 'inquiry' %} {% if question.target == 'sens' %} ({% trans 'sensitivity' %}) {% elif question.target == 'admin' %} ({% trans 'admin_question' %}) {% else %} ({{ question.result.collectionName }}) {% endif %}{% trans "handler_answered" %}&#10;&#13;{{question.message}}</p></div>
				</div>
				{% endif %}
			{% endfor %}
			{% if role2 %}
			<h4>{% trans "handler_form_to_request_additional_information" %}</h4>
			<form action="{% url 'pyha:question' %}" id="requestform" method="post">
				<div class="form-group">
					<input type="hidden" id="requestid" name="requestid" value={{userRequest.id}}>
					<input type="hidden" id="next" name="next" value="{{request.path}}?next=information">
					<span>{% trans 'ask_as_handler_of'%}</span>
					<select id="target" name="target">
					{% for collection in collections %}
						{% if collection.address in handles %}
						<option value="{{collection.address}}">{{collection.result.collectionName}}</option>
						{% endif %}
					{% endfor %}
					</select>
					<textarea class="form-control" rows="5" cols="70" id="reason" name="reason" required {% if userRequest.status == 3 or userRequest.status == 7 or userRequest.status == 8 or userRequest.frozen %} disabled {% endif %}></textarea>
					<button type="submit" id="submit" name="answer" value=2 class="btn btn-default btn-sm" {% if userRequest.status == 3 or userRequest.status == 7 or userRequest.status == 8 or userRequest.frozen %} disabled {% endif %}>{% trans "handler_request_additional_information" %}</button>
				</div>
				{% csrf_token %}
			</form>
			{% else %}
			<h4>{% trans "collection_free_of_sensitive_data" %}</h4>
			{% endif %}
		</div>
		{% if role2 %}
		<div class="request-view-pane tab-pane {% if next == 'comments' %} active {% endif %}" role="tabpanel" id="handler_comments">
			<div>
				<div>
					<h3>{% trans "col_handler_comments_window" %}</h3>
					<p>{% trans "col_handler_comments_window_description" %}</p>
					<span>{% trans "this_section_is_only_visible_to_collection_handlers_not_request_owner" %}</hspan>
					{% for requestHandlerChat in requestHandlerChat_list %}
					<div class="panel panel-default">
					<div class="panel-body" {% if requestHandlerChat.user == user %} style="background-color:#d9edf7;" {% endif %}><p>{{requestHandlerChat.date|date:"d.m.Y H:i"}} {{ requestHandlerChat.name }}  {% if question.target == 'admin' %} ({% trans 'admin_question' %}) {% else %} ({{ requestHandlerChat.result.collectionName }}) {% endif %} {% trans "col_handler_said" %}&#10;&#13;{{requestHandlerChat.message}}</p></div>
					</div>
					{% endfor %}
					<form action="{% url 'pyha:comment_handler' %}" id="commentform" method="post">
					<div class="form-group">
						<input type="hidden" id="collectionid" name="collectionid" value="sens">
						<input type="hidden" id="next" name="next" value="{{request.path}}?next=comments">
						<input type="hidden" id="requestid" name="requestid" value={{userRequest.id}}>
						<span>{% trans 'talk_as_handler_of' %}</span>
						<select id="target" name="target">
						{% for collection in collections %}
							{% if collection.address in handles %}
							<option value="{{collection.address}}">{{collection.result.collectionName}}</option>
							{% endif %}
						{% endfor %}
						</select>
						<textarea class="form-control" rows="5" cols="700" id="commentsForHandlers" name="commentsForHandlers" style="overflow:auto;resize:none" required {% if userRequest.status == 3 or userRequest.status == 7 or userRequest.status == 8 or userRequest.frozen %} disabled {% endif %} ></textarea>
						<button type="submit" id="submit" name="answer" value=1 class="btn btn-default btn-sm" {% if userRequest.status == 3 or userRequest.status == 7 or userRequest.status == 8 or userRequest.frozen %} disabled {% endif %}>{% trans "handler_save" %}</button>
					</div>
					{% csrf_token %}
					</form>
				</div>
			</div>
		</div>
		{% endif %}
	</div>
{% endblock %}

{% block end_script %}
	{% if coordinates %}
	<script>
		$(document).ready(function(){
			$('[data-toggle="tooltip"]').tooltip();
			initializeMap();
			map.setView([{{coordinates.5}}, {{coordinates.6}}], 7);
			document.getElementById('filters').style.display = 'block';
			map.invalidateSize();
			document.getElementById('filters').style.display = '';
			var bounds = [[{{coordinates.0}}, {{coordinates.2}}], [{{coordinates.1}},{{coordinates.3}}]];
			L.rectangle(bounds, {color: "#ff7800", weight: 1}).addTo(map);
		});
	</script>
	{% endif %}
	<script>
		function showDecline() {
			var x = document.getElementById('sensitive_refuse_form');
			if (x.style.display == 'none') {
				x.style.display = 'block';
			}
		}
	</script>
	{% if next == 'information' %}
	<script>
		$(document).ready(function(){
			document.getElementById('additional_information').scrollIntoView();
			document.getElementById('requestform').scrollIntoView();
		});
	</script>
	{% endif %}
	{% if next == 'decision' %}
	<script>
		$(document).ready(function(){
			document.getElementById('decision-tab').scrollIntoView();
		});
	</script>
	{% endif %}
{% endblock %}
