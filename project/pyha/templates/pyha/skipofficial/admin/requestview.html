{% extends "pyha/base/requestview_base.html" %}
{% load i18n %}

{% block page_content %}
	<div class="tab-content">
		<div class="request-view-pane tab-pane {% if next == 'request' %} active {% endif %}" role="tabpanel" id="request">
			<h3>{% trans "admin_request_window" %}</h3>
			<p>{% trans "admin_request_window_description" %}</p>
			{% if taxon %}
			<p>{% trans 'given_values_are_not_absolute' %}</p>
			{% endif %}
				<table class="table" style="width:100%">
					<tr style=color:black>
						<th>{% trans "admin_collection_name" %}</th>
						<th></th>
						<th>{% trans "admin_collection_description" %}</th>
						<th>{% trans "admin_collection_quality_description" %}</th>
						<th>{% trans "admin_collection_terms" %}</th>
						<th>{% trans "admin_secured_by_quarantine" %}<small><a class="normaltooltip"> [?]<span class="normaltooltiptext">{% trans 'secured_by_quarantine_explanation'%}</span></a></small></th>
						<th>{% trans "admin_secured_by_sensitivity" %}<small><a class="normaltooltip"> [?]<span class="normaltooltiptext">{% trans 'secured_by_sensitivity_explanation'%}</span></a></small></th>
						<th>{% trans "admin_secured_by_data_provider" %}<small><a class="normaltooltip"> [?]<span class="normaltooltiptext">{% trans 'secured_by_dataprovider_explanation'%}</span></a></small></th>
						<th>{% trans "admin_state_of_processing" %}</th>
					</tr>
				{% for collection in collections %}
					{% if collection.status == 1 %}
					<tr class="info clickable-row">
					{% elif collection.status == 3 %}
					<tr class="danger clickable-row">
					{% elif collection.status == 4 %}
					<tr class="success clickable-row">
					{% else %}
					<tr>
					{% endif %}
					<td>{{collection.result.collectionName}}</td>
					<td><small>[<a href="{{tun_link}}{{collection.address}}" target="_blank">{% trans 'to_metadata' %}</a>]</small></td>
					<td>{{collection.result.description}}</td>
					<td>{{collection.result.qualityDescription}}</td>
					<td>{{collection.result.collectionTerms}}</td>
					<td>{{collection.quarantineSecured}}</td>
					<td>{{collection.taxonSecured}}</td>
					<td>{{collection.customSecured}}</td>
					{% if collection.status == 1 %}
						{% if collection.address in handles %}
						<td>{% trans "admin_waiting_for_you" %}</td>
						{% else %}
						<td>{% trans "admin_waiting_for_others" %}</td>
						{% endif %}
					{% elif collection.status == 3 %}
					<td>{% trans "denied" %}</td>
					{% elif collection.status == 2 %}
					<td>{% trans "partially_accepted" %}</td>
					{% elif collection.status == 4 %}
					<td>{% trans "accepted" %}</td>
					{% elif collection.taxonSecured > 0 %}
					<td>{% trans "Admission_for_sensitive_data" %}</td>
					{% else %}
					<td>{% trans "unknown" %}</td>
					{% endif %}
				{% endfor %}
			</table>
		</div>
		<div class="request-view-pane tab-pane {% if next == 'filters' %} active {% endif %}" role="tabpanel" id="filters">
			<h3>{% trans "admin_filter_window" %} </h3> <a style="padding-left:8px;" href="{{ filter_link }}">{% trans "admin_show_in_portal" %}</a>
			<p>{% trans "admin_filter_window_description" %}</p>
				{% if filters %}
					<table class = "table" style="width:100%">
						<tr style=color:black>
							<th>{% trans "admin_filter" %}</th>
							<th>{% trans "admin_values" %}</th>
						</tr>
						{% for filter in filters %}
						<tr>
							<td rowspan={{filter.1|length}}>{{ filter.2 }}</td>
							{% for f in filter.1 %}
							<td>{{ f }}</td>
						</tr>
							<tr>
							{% endfor %}
							</tr>
						{% endfor %}
					</table>
					{% if coordinates %}
					<div id="filtermap"></div>
					{% endif %}
				{% else %}
					<strong>{% trans "admin_no_filters" %}.</strong>
				{% endif %}
		</div>
		<div class="request-view-pane tab-pane {% if next == 'terms' %} active {% endif %}" role="tabpanel" id="terms">
				<h3>{% trans "admin_terms_window" %}</h3>
				<p>{% trans "admin_terms_window_description" %}</p>
				<table class="table" style="width:100%">
					<tr>
						<td>{% trans "Collection terms" %}</td>
						<td><button type="button" class="btn btn-default btn-sm" required data-toggle="modal" data-target="#myModalsens">{% trans "terms" %}</button></td>
						</tr>
							<!-- Sens Modal -->
							<div class="modal fade" id="myModalsens" tabindex="-1" role="dialog" aria-labelledby="sensiModalLabel">
							  <div class="modal-lg modal-dialog" role="document">
								<div class="modal-content">
									<div class="modal-header">
									<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
									<h4 class="modal-title" id="myModalLabel">{% trans "sensitive_and_other_terms" %}</h4>
									<form action="{% url 'pyha:newpdf' %}" onsubmit="this.source.value=document.getElementById('sens-content').outerHTML" method="post">
										<button type="submit" class="btn btn-default btn-sm">{% trans "as_pdf" %}</button>
										<input type="hidden" name="source" />
										{% csrf_token %}
									</form>
									</div>
									<div id="sens-content" class="modal-body">
									<div style="float:left;">
									<svg xmlns="http://www.w3.org/2000/svg"
										width="60" height="160" version="1.1" baseProfile="full"
										style="width: 60px; height: 160px; display: block;">
										<g transform="rotate(270)">
											<text textLength="160" fill="#777777" font-weight="700" font-size="50px" style="font-family: Arial, Helvetica, sans-serif;">
												<tspan x="-160" dy="50" >LAJI.FI</tspan>
											</text>
										   </g>
									  </svg>
									</div>
									<div style="margin-left:120px;margin-top:50px;">
										{% include sensitivity_terms %}
										<div style="margin-left:30px">
										<ul>
											<li><p class="model-field">{% trans 'contact_name' %} {{contactlist.0.personName}}</p></li>
											<ul>
											<li><p class="model-field">{% trans 'contact_street_address' %} {{contactlist.0.personStreetAddress}}</p></li>
											<li><p class="model-field">{% trans 'contact_postal' %} {{contactlist.0.personPostalCode}}</p></li>
											<li><p class="model-field">{% trans 'contact_post_office' %} {{contactlist.0.personPostOfficeName}}</p></li>
											<li><p class="model-field">{% trans 'contact_country' %} {{contactlist.0.personCountry}}</p></li>
											<li><p class="model-field">{% trans 'contact_email' %} {{contactlist.0.personEmail}}</p></li>
											<li><p class="model-field">{% trans 'contact_phone_number' %} {{contactlist.0.personPhoneNumber}}</p></li>
											{% if contactlist.0.personOrganizationName != "" %}
											<li><p class="model-field">{% trans 'contact_corporation' %} {{contactlist.0.personOrganizationName}}</p></li>
											{% endif %}
											{% if contactlist.0.personCorporationId != "" %}
											<li><p class="model-field">{% trans 'contact_corporation_id' %} {{contactlist.0.personCorporationId}}</p></li>
											{% endif %}
											</ul>
										</ul>
											{% for contact in contactlist|slice:"1:" %}
										<p style="width:100%;height:12px;"></p>
										<ul>
											<li><p class="model-field">{% trans 'additional_contact_name' %} {{contact.personName}}</p></li>
											<ul>
											<li><p class="model-field">{% trans 'contact_street_address' %} {{contact.personStreetAddress}}</p></li>
											<li><p class="model-field">{% trans 'contact_postal' %} {{contact.personPostalCode}}</p></li>
											<li><p class="model-field">{% trans 'contact_post_office' %} {{contact.personPostOfficeName}}</p></li>
											<li><p class="model-field">{% trans 'contact_country' %} {{contact.personCountry}}</p></li>
											<li><p class="model-field">{% trans 'contact_email' %} {{contact.personEmail}}</p></li>
											<li><p class="model-field">{% trans 'contact_phone_number' %} {{contact.personPhoneNumber}}</p></li>
											{% if contact.personOrganizationName != "" %}
											<li><p class="model-field">{% trans 'contact_corporation' %} {{contact.personOrganizationName}}</p></li>
											{% endif %}
											{% if contact.personCorporationId != "" %}
											<li><p class="model-field">{% trans 'contact_corporation_id' %} {{contact.personCorporationId}}</p></li>
											{% endif %}
											</ul>
										</ul>
											{% endfor %}
										</div>
									</div>
								  </div>
								  <div class="modal-footer">
									<button type="button" class="btn btn-default" data-dismiss="modal" id=>{% trans "exit" %}</button>
								  </div>
								</div>
							  </div>
							</div>
				</table>
		</div>
		<div class="request-view-pane tab-pane {% if next == 'decision' %} active {% endif %}" role="tabpanel" id="decision">
			<h3>{% trans "admin_decision_window" %}</h3>
			<p>{% trans "admin_decision_window_description" %}</p>
			{% if collections %}
			<h4>{% trans "admin_secured_collection_decicions" %}</h4>
			<form action="{% url 'pyha:group_answer' %}" id="requestform" method="post">
				<table class="table" style="width:100%">
					<tr style=color:black>
						<th>{% trans "admin_collection_name" %}</th>
						<th></th>
						<th>{% trans "admin_collection_description" %}</th>
						<th>{% trans "admin_state_of_processing" %}</th>
						<th>{% trans "admin_decision_arguments" %}</th>
						<th>{% trans "admin_select" %}</th>
						<th>{% trans "admin_make_decision" %}</th>
					</tr>
					{% for collection in collections %}
						{% if collection.status == 1 %}
						<tr class="info clickable-row">
						{% elif collection.status == 3 %}
						<tr class="danger clickable-row">
						{% elif collection.status == 4 %}
						<tr class="success clickable-row">
						{% else %}
						<tr>
						{% endif %}
							<td>{{collection.result.collectionName}}</td>
							<td><small>[<a href="{{tun_link}}{{collection.address}}" target="_blank">{% trans 'to_metadata' %}</a>]</small></td>
							<td>{{collection.result.description}}</td>

							{% if collection.status == 1 %}
								{% if collection.address in handles %}
								<td>{% trans "admin_waiting_for_you" %}</td>
								{% else %}
								<td>{% trans "admin_waiting_for_others" %}</td>
								{% endif %}
							{% elif collection.status == 3 %}
							<td>{% trans "admin_denied" %}</td>
							{% elif collection.status == 2 %}
							<td>{% trans "admin_partially_accepted" %}</td>
							{% elif collection.status == 4 %}
							<td>{% trans "admin_accepted" %}</td>
							{% else %}
							<td>{% trans "admin_unknown" %}</td>
							{% endif %}
							<td>{% if collection.decisionExplanation %}<p>{{collection.decisionExplanation}}</p>{% else %}{% endif %}</td>
							<td>
								<p style="text-align: center;"><input {% if frozen %} disabled {% endif %} onChange="" type="checkbox" name="collection_id_{{ collection.id }}" value="{{ collection.address }}" style="vertical-align: middle;"></p>
							</td>
							{% if forloop.first %}
								<td rowspan="{{collections|length}}" style="background-color:white; border-bottom:0px;">
									<h5>{% trans "admin_decision_arguments" %}</h5>
									<span>{% trans "admin_select_checksboxes_to_apply_this_decision_to" %}</span>
									<div class="form-group">
										<input type="hidden" id="requestid" name="requestid" value={{userRequest.id}}>
										<input type="hidden" id="next" name="next" value="{{request.path}}?next=decision">
										<textarea class="form-control" rows="5" cols="700" id="reason" name="reason"></textarea>
										<p style="margin:2px;">{% trans "admin_arguments_will_be_applied_to_all_selected" %}</p>
										<button type="submit" id="submit" name="answer" value=1 class="btn btn-success btn-sm" {% if userRequest.frozen %} disabled {% endif %}>{% trans "admin_accept" %}</button>
										<button type="submit" id="submit" name="answer" value=3 class="btn btn-default btn-sm" {% if userRequest.frozen %} disabled {% endif %}>{% trans "admin_reset" %}</button>
										<button type="submit" id="submit" name="answer" value=0 class="btn btn-danger btn-sm" {% if userRequest.frozen %} disabled {% endif %}>{% trans "admin_refuse" %}</button>
									</div>
								</td>
							{% endif %}
						</tr>
					{% endfor %}
				</table>
				{% csrf_token %}
			</form>
			{% endif %}
		</div>
		<div class="request-view-pane tab-pane {% if next == 'information' %} active {% endif %}" role="tabpanel" id="additional_information">
			<h3>{% trans "admin_additional_information_window" %}</h3>
			<p>{% trans "admin_additional_information_window_description" %}</p>
			{% for question in requestInformationChat_list %}
				{% if question.question %}
				<div class="panel panel-default" {% if question.user == user %} style="background-color:#d9edf7;" {% endif %}>
				<div class="panel-body"><p>{{question.date|date:"d.m.Y H:i"}} {{ question.name }} {% if question.target == 'sens' %} ({% trans 'sensitivity' %}){% elif question.target == 'admin' %} ({% trans 'admin_question' %}) {% else %} ({{ question.result.collectionName }}) {% endif %} {% trans "admin_asked" %}&#10;&#13;{{question.message}}</p></div>
				</div>
				{% endif %}
				{% if question.question != True %}
				<div class="panel panel-default" {% if question.user == user %} style="background-color:#d9edf7;" {% endif %}>
				<div class="panel-body"><p>{{question.date|date:"d.m.Y H:i"}} {{ question.name }} {% trans 'inquiry' %} {% if question.target == 'sens' %} ({% trans 'sensitivity' %}) {% elif question.target == 'admin' %} ({% trans 'admin_question' %}) {% else %} ({{ question.result.collectionName }}) {% endif %}{% trans "admin_answered" %}&#10;&#13;{{question.message}}</p></div>
				</div>
				{% endif %}
			{% endfor %}
			<h4>{% trans "admin_form_to_request_additional_information" %}</h4>
			<form action="{% url 'pyha:question' %}" id="requestform" method="post">
				<div class="form-group">
					<input type="hidden" id="requestid" name="requestid" value={{userRequest.id}}>
					<input type="hidden" id="next" name="next" value="{{request.path}}?next=information">
					<span>{% trans 'ask_as_admin_of'%}</span>
					<select id="target" name="target">
						<option value="admin">{% trans "as_admin" %}</option>
					</select>
					<textarea class="form-control" rows="5" cols="70" id="reason" name="reason" required {% if userRequest.frozen %} disabled {% endif %}>{% if collection.decisionExplanation %}{{collection.decisionExplanation}}{% else %}{% endif %}</textarea>
					<button type="submit" id="submit" name="answer" value=2 class="btn btn-default btn-sm" {% if userRequest.frozen %} disabled {% endif %}>{% trans "admin_request_additional_information" %}</button>
				</div>
				{% csrf_token %}
			</form>
		</div>

		<div class="request-view-pane tab-pane {% if next == 'comments' %} active {% endif %}" role="tabpanel" id="handler_comments">
			<div>
				<div>
					<h3>{% trans "col_handler_comments_window" %}</h3>
					<p>{% trans "col_handler_comments_window_description" %}</p>
					<span>{% trans "this_section_is_only_visible_to_collection_handlers_not_request_owner" %}</hspan>
					{% for requestHandlerChat in requestHandlerChat_list %}
					<div class="panel panel-default">
					<div class="panel-body" {% if requestHandlerChat.user == user %} style="background-color:#d9edf7;" {% endif %}><p>{{requestHandlerChat.date|date:"d.m.Y H:i"}} {{ requestHandlerChat.name }} {% if requestHandlerChat.target == 'admin' %} ({% trans 'admin_question' %}) {% else %} ({{ requestHandlerChat.result.collectionName }}) {% endif %} {% trans "col_handler_said" %}&#10;&#13;{{requestHandlerChat.message}}</p></div>
					</div>
					{% endfor %}
					<form action="{% url 'pyha:comment_handler' %}" id="commentform" method="post">
					<div class="form-group">
						<input type="hidden" id="collectionid" name="collectionid" value="sens">
						<input type="hidden" id="next" name="next" value="{{request.path}}?next=comments">
						<input type="hidden" id="requestid" name="requestid" value={{userRequest.id}}>
						<span>{% trans 'talk_as_handler_of' %}</span>
						<select id="target" name="target">
							<option value="admin">{% trans "as_admin" %}</option>
						</select>
						<textarea class="form-control" rows="5" cols="700" id="commentsForHandlers" name="commentsForHandlers" style="overflow:auto;resize:none" required {% if userRequest.frozen %} disabled {% endif %}></textarea>
						<button type="submit" id="submit" name="answer" value=1 class="btn btn-default btn-sm" {% if userRequest.frozen %} disabled {% endif %}>{% trans "handler_save" %}</button>
					</div>
					{% csrf_token %}
					</form>
				</div>
			</div>
		</div>

		<div class="request-view-pane tab-pane {% if next == 'communications' %} active {% endif %}" role="tabpanel" id="handler_communications">
			{% if handler_groups %}
			<form action="{% url 'pyha:refresh_collections_cache' %}" id="refreshform" method="post">
				<h3 id="communications_header">
					{% trans "admin_communications_window" %}
					<input type="hidden" id="next" name="next" value="{{request.path}}?next=communications">
					<button type="submit" id="submit_refresh" name="send" value=1 class="btn btn-default btn-sm">{% trans "admin_refresh_collections_cache" %}</button>
					{% csrf_token %}
				</h3>
				<p>{% trans "admin_communications_window_description" %}</p>
			</form>
				{% if com_last_automated_send_email %}
					<div class="form-group stale-form">
						<h>{% trans "admin_automated_emails_sent_last_time" %}: {{ com_last_automated_send_email|date:"d.m.Y    H:i"}}</h>
					</div>
				{% endif %}
			<form action="{% url 'pyha:send_email' %}" id="requestform" method="post">
				<table id="communications_table" class="table" style="width:100%;">
					<tr>
						<th>{% trans "admin_communications_collections" %}</th>
						<th style="text-align:right;">{% trans "admin_communications_handlers" %}</th>
						<th>{% trans "admin_communications_state" %}</th>
						<th>{% trans "admin_send_email" %}</th>
						<th>{% trans "admin_communications_email" %}</th>
					</tr>
					{% for group in handler_groups %}
						{% if group.handlers.0.id == 'None' %}
							<tr>
								<td colspan=2 style="vertical-align: middle;">
									<table class="collection-group-error" style="width:100%">
										<tr>
											<td style="border-bottom:0; width:100%">
											{% for collection in group.collections %}
												<p style="white-space: nowrap;"><a href="{{tun_link}}{{collection.id}}" target="_blank">{{ collection.collectionName }}</a></p>
											{% endfor %}
											</td>
											<td style="border-bottom:0;">
											{% for handler in group.handlers %}
												<p style="white-space: nowrap;">{% trans 'admin_name_is_none' %}</p>
											{% endfor %}
											</td>
										</tr>
									</table>
								</td>
								<td style="vertical-align: middle; line-height: 40px;">
									<p style="margin-bottom: 16px; color:red;">{% trans "admin_collections_missing_handler" %}</p>
								</td>
								<td></td>
								{% if forloop.first %}
								<td rowspan="{{handler_groups|length}}"  style="border:0px; border-top: 1px solid #ddd; border-left: 1px solid #ddd;">
										<div class="form-group">
											<input type="hidden" id="requestid" name="requestid" value={{userRequest.id}}>
											<input type="hidden" id="next" name="next" value="{{request.path}}?next=communications">
											<table style="width:100%;">
											<tr>
												<td style="border:0px;">{% trans "email_sender" %}</td>
												<td style="width:100%; border:0px;"><input type="text" id="com_email_sender" name="com_email_sender" value="{{ com_email_template.sender }}" style="width:100%;padding:6px 12px;"></td>
											</tr>
											<tr>
												<td style="border:0px;">{% trans "email_header" %}</td>
												<td style="width:100%; border:0px;"><input type="text" id="com_email_header" name="com_email_header" value="{{ com_email_template.header }}" style="width:100%;padding:6px 12px;"></td>
											</tr>
											<tr>
												<td style="border:0px;">{% trans "email_lang" %}</td>
												<td style="width:100%; border:0px;">
													<select onchange="refreshCommunicationsEmailByLang();" id="admin_com_email_lang" name="admin_com_email_lang" style="padding:0px 9px;">
														{% for code in com_email_templates %}
															<option {% if LANGUAGE == code %} selected="selected" {% endif %} value="{{ code }}">{{ code }}</option>
											            {% endfor %}
											            	<option value="all">{% trans "admin_email_lang_all" %}</option>
													</select>
													{% for code, values in com_email_templates.items %}
													<p hidden="true" id="com_email_header_{{ code }}">{{ values.header }}</p>
													<p hidden="true" id="com_email_content_{{ code }}">{{ values.content }}</p>
													{% endfor %}
												</td>
											</tr>
											</table>
											<textarea class="form-control" rows="15" cols="70" id="com_email_content" name="com_email_content">{{ com_email_template.content }}</textarea>
											<button type="submit" id="submit_email" name="send" value=1 class="btn btn-default btn-sm" {% if userRequest.frozen %} disabled {% endif %}>{% trans "admin_send" %}</button>
										</div>
								</td>
								{% endif %}
							</tr>
						{% else %}
							<tr>
								<td colspan=2 style="vertical-align: middle;">
									<table class="collection-group" style="width:100%">
										<tr>
											<td style="border-bottom:0; width:100%">
											{% for collection in group.collections %}
												<p style="white-space: nowrap;"><a href="{{tun_link}}{{collection.id}}" target="_blank">{{ collection.collectionName }}</a></p>
											{% endfor %}
											</td>
											<td style="border-bottom:0;">
											{% for handler in group.handlers %}
												<p style="white-space: nowrap; text-align:right;">[{{ handler.id }}] {{ handler.name }} ({{ handler.email }})</p>
											{% endfor %}
											</td>
										</tr>
									</table>
								</td>
								<td style="vertical-align: middle; line-height: 40px;">
									{% for handler in group.handlers %}
										{% if handler.mailed %}
											<p style="margin-bottom: 10px;">{% trans "emailed" %}</p>
										{% else %}
											<p style="margin-bottom: 10px;">{% trans "not_emailed" %}</p>
										{% endif %}
									{% endfor %}
										<div style="margin-bottom: 16px;"></div>
								</td>
								<td style="vertical-align: middle; line-height: 40px;">
									{% for handler in group.handlers %}
										<p style="white-space: nowrap;"><input {% if handler.mailed or frozen %} disabled {% endif %} onChange="enableCommunicationsEmail()" type="checkbox" name="email_id_{{ handler.id }}" value="{{ handler.email }}" style="margin-top: 0px; margin-left: 15px; vertical-align: middle;"></p>
									{% endfor %}
										<div style="margin-bottom: 16px;"></div>
								</td>
								{% if forloop.first %}
								<td rowspan="{{handler_groups|length}}"  style="border:0px; border-top: 1px solid #ddd; border-left: 1px solid #ddd;">
										<div class="form-group">
											<input type="hidden" id="requestid" name="requestid" value={{userRequest.id}}>
											<input type="hidden" id="next" name="next" value="{{request.path}}?next=communications">
											<table style="width:100%;">
											<tr>
												<td style="border:0px;">{% trans "email_sender" %}</td>
												<td style="width:100%; border:0px;"><input type="text" id="com_email_sender" name="com_email_sender" value="{{ com_email_template.sender }}" style="width:100%;padding:6px 12px;"></td>
											</tr>
											<tr>
												<td style="border:0px;">{% trans "email_header" %}</td>
												<td style="width:100%; border:0px;"><input type="text" id="com_email_header" name="com_email_header" value="{{ com_email_template.header }}" style="width:100%;padding:6px 12px;"></td>
											</tr>
											<tr>
												<td style="border:0px;">{% trans "email_lang" %}</td>
												<td style="width:100%; border:0px;">
													<select onchange="refreshCommunicationsEmailByLang();" id="admin_com_email_lang" name="admin_com_email_lang" style="padding:0px 9px;">
														{% for code in com_email_templates %}
															<option {% if LANGUAGE == code %} selected="selected" {% endif %} value="{{ code }}">{{ code }}</option>
											            {% endfor %}
											            	<option value="all">{% trans "admin_email_lang_all" %}</option>
													</select>
													{% for code, values in com_email_templates.items %}
													<p hidden="true" id="com_email_header_{{ code }}">{{ values.header }}</p>
													<p hidden="true" id="com_email_content_{{ code }}">{{ values.content }}</p>
													{% endfor %}
												</td>
											</tr>
											</table>
											<textarea class="form-control" rows="15" cols="70" id="com_email_content" name="com_email_content">{{ com_email_template.content }}</textarea>
											<button type="submit" id="submit_email" name="send" value=1 class="btn btn-default btn-sm" {% if userRequest.frozen %} disabled {% endif %}>{% trans "admin_send" %}</button>
										</div>
								</td>
								{% endif %}
							</tr>
						{% endif %}
					{% endfor %}
				</table>
				{% csrf_token %}
			</form>
			{% else %}
			<h3>{% trans "admin_communications_window" %}</h3>
			<p>{% trans "admin_communications_window_description" %}</p>
			<strong>{% trans "no_communications" %}</strong>
			{% endif %}
		</div>
{% endblock %}

{% block end_script %}
	{% if coordinates %}
	<script>
		$(document).ready(function(){
			$('[data-toggle="tooltip"]').tooltip();
			initializeMap();
			map.setView([{{coordinates.5}}, {{coordinates.6}}], 7);
			document.getElementById('filters').style.display = 'block';
			map.invalidateSize();
			document.getElementById('filters').style.display = '';
			var bounds = [[{{coordinates.0}}, {{coordinates.2}}], [{{coordinates.1}},{{coordinates.3}}]];
			L.rectangle(bounds, {color: "#ff7800", weight: 1}).addTo(map);
		});
	</script>
	{% endif %}
	{% if next == 'comments' %}
	<script>
		$(document).ready(function(){
			document.getElementById('commentform').scrollIntoView();
		});
	</script>
	{% endif %}
	<script>
		function showDecline() {
			var x = document.getElementById('sensitive_refuse_form');
			if (x.style.display == 'none') {
				x.style.display = 'block';
			}
		}
	</script>
	<script>
		function refreshCommunicationsEmailByLang() {
			var x = document.getElementById('admin_com_email_lang');
			var strLang = x.options[x.selectedIndex].value;

			if (strLang == 'all'){
				document.getElementById('com_email_header').value = document.getElementById('com_email_header_fi').innerHTML;
				document.getElementById('com_email_content').value = '{%trans "in_other_languages_below"%}\n\n\n\n';
				{% for lang in languages %}
				document.getElementById('com_email_content').value += document.getElementById('com_email_content_{{ lang.code }}').innerHTML;
				document.getElementById('com_email_content').value += '\n\n------------------------------------';
					{% if not forloop.last %}
						document.getElementById('com_email_content').value += '\n\n\n';
					{% endif %}
				{% endfor %}
			} else {
				document.getElementById('com_email_header').value = document.getElementById('com_email_header_'+strLang).innerHTML;
				document.getElementById('com_email_content').value = document.getElementById('com_email_content_'+strLang).innerHTML;
			}

		}
	</script>
	<script>
		function enableCommunicationsEmail() {
			var x = document.querySelectorAll('[name^=email_id_]');
			var b = false;
			for (i = 0; i < x.length; i++){
				if(x[i].checked){
					b = true;
					break;
				}
			}
			{% if not userRequest.frozen %}
			document.getElementById('submit_email').disabled = !b;
			{% endif %}

		}
	</script>
	{% if next == 'information' %}
	<script>
		$(document).ready(function(){
			document.getElementById('additional_information').scrollIntoView();
			document.getElementById('requestform').scrollIntoView();
		});
	</script>
	{% endif %}
	{% if next == 'communications' %}
	<script>
		$(document).ready(function(){
			document.getElementById('handler_communications-tab').scrollIntoView();
		});
	</script>
	{% endif %}
	{% if next == 'decision' %}
	<script>
		$(document).ready(function(){
			document.getElementById('decision-tab').scrollIntoView();
		});
	</script>
	{% endif %}
	<script>
		$(document).ready(function(){
			refreshCommunicationsEmailByLang();
			enableCommunicationsEmail();
		});
	</script>
{% endblock %}
