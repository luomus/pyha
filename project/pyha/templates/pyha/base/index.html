{% extends "pyha/base/base.html" %}
{% block content %}
{% load i18n %}
{% load pyha_tags %}


<div class="container-fluid">
  <div class="row">
 	  <div class="col-xs-12">
      <div class="page-header">
        <h2>{% trans "welcome" %}</h2>
      </div>

      {% if has_requests %}
      <h2>{% trans "all_requests" %}</h2>
      <p class ="text-muted">{% trans "click_for_info" %}.</p>

      {% if role == "handler" or role == "admin" %}
      <div style="margin-bottom: 10px">
          <button id="showOnlyUncompletedRequestsTrueBtn" class="btn btn-default" onclick="showOnlyUncompletedRequestsChange(true)">{% trans "show_uncompleted_requests" %}</button>
          <button id="showOnlyUncompletedRequestsFalseBtn" class="btn btn-default" onclick="showOnlyUncompletedRequestsChange(false)">{% trans "show_all_requests" %}</button>
      </div>
      {% endif %}
      <form action="{% url 'pyha:group_delete_request' %}" id="delete_requests" method="post" style="margin-bottom: 30px">
        <table id="requests-table" class="table table-hover table-bordered" width="100%">
          <thead>
            <tr bgcolor="{% if role == 'handler' %}#349934{% elif role == 'admin' %}#8080c0{% else %}#3498DB{% endif %}" style="color:white;">
              {% if role == "handler" %}
              <th title="{% trans 'handler_new_events' %}" style="width:0px;">{% trans 'handler_new_events_abbreviation' %}</th>
              {% endif %}
              <th>{% trans "request_date" %}</th>
              {% if role == "handler" or role == "admin" %}
              <th>{% trans "requester" %}</th>
              {% endif %}
              <th {% if role == "user" %}title="{% trans 'given_values_are_not_absolute' %}{% endif %}">{% trans "request_hits" %}</th>
              {% if role == "user" %}
              <th>{% trans "request_status_for_user" %}</th>
              <th>{% trans "request_description" %}</th>
              <th>{% trans "select_canceled" %}</th>
              {% endif %}
              {% if role == "handler" or role == "admin" %}
              <th>{% trans "request_information_status" %}</th>
              <th>{% trans "request_download_status" %}</th>
              <th>{% trans "request_status_for_user" %}</th>
              {% endif %}
              {% if role == "admin" %}
              <th>{% trans "select_deleted" %}</th>
              {% endif %}
            </tr>
          </thead>
        </table>
        {% if role == "user" %}
        <p>{% trans 'given_values_are_not_absolute' %}</p>
        <button type="submit" id="submit_delete_requests" class="btn btn-danger btn-sm" disabled>{% trans "delete_or_withdraw_selected_requests" %}</button>
        {% endif %}
        {% if role == "admin" %}
        <button type="submit" id="submit_delete_requests" class="btn btn-danger btn-sm" disabled>{% trans "delete_selected_requests" %}</button>
        {% endif %}
      {% csrf_token %}
      </form>

      {% else %}
      	<strong>{% trans "no_requests_for_user" %}.</strong>
      {% endif %}
    </div>
  </div>
</div>

{% endblock %}

{% block end_script %}
{% if role == "user" or role == "admin" %}
<script>
function checkSelected() {
  var disabled = true;

  var checkboxes = document.getElementsByClassName('select_request_checkbox');
  for (var i = 0; i < checkboxes.length; i++) {
    var checkbox = checkboxes[i];
    if (checkbox.checked && !checkbox.disabled) {
      disabled = false;
    }
  }

  document.getElementById('submit_delete_requests').disabled = disabled;
}
</script>
{% endif %}
<script>
const allColumns = [
    { "data": "date", "render": $.fn.dataTable.render.moment('YYYY-MM-DDTHH:mm:ss.SSS', 'DD.MM.YYYY    HH:mm') },
    {
        "data": "approximateMatches",
        "render": $.fn.dataTable.render.number(" ", ","),
        "createdCell": function(td, cellData, rowData, row, col) {
            $(td).attr("title", "{% trans 'given_values_are_not_absolute' %}");
        }
    },
    {
        "data": "statusText"
    },
    {
        "data": "description",
        "render": $.fn.dataTable.render.text(),
        "createdCell": function(td, cellData, rowData, row, col) {
            $(td).css({"white-space": "pre-wrap"});
        }
    },
    { "data": "email", "render": $.fn.dataTable.render.text() },
    { "data": "observationCount", "render": $.fn.dataTable.render.number(" ", ",") },
    {
        "data": "informationStatus",
        "render": function(data, type, row) {
            var content = "";
            if (data == 0) {
                content = "{% trans "waiting_for_additional_information" %}";
            } else if (data == 1) {
                content = "{% trans "user_has_given_additional_information" %}";
            }
            return content;
        }
    },
    {
        "data": "downloadStatus",
        "render": function(data, type, row) {
            var content = "";
            if (data == 0) {
                content = "{% trans "data_is_not_downloaded" %}";
            } else if (data == 1) {
                content = "{% trans "data_is_partly_downloaded" %}";
            } else if (data == 2) {
                content = "{% trans "data_is_downloaded" %}";
            }
            return content;
        }
    },
    {
        "data": "decisionStatus",
        "render": function(data, type, row) {
            var content = "";
            if (data == -1) {
                content = "{% trans "withdrawn" %}";
            } else if (data == 0) {
                content = "{% trans "no_decisions" %}";
            } else if (data == 1) {
                content = "{% trans "decisions_partly_done" %}";
            } else if (data == 2) {
                content = "{% trans "decisions_done" %}";
            }
            return content;
        }
    },
    {
        "data": null,
        "defaultContent": "",
        "render": function(data, type, row) {
            var content = "<input class=\"select_request_checkbox\" name=\"request_id_";
            content += data.id;
            content += "\" type=\"checkbox\" onChange=\"checkSelected()\" style=\"margin: 0;\">";
            return content;
        },
        "createdCell": function(td, cellData, rowData, row, col) {
            $(td).addClass("checkbox-column text-center");
        },
        "sortable": false
    },
    {
        "data": null,
        "render": function(data, type, row) {
            if (!row.viewed || row.answerStatus == 1) {
                return "<span class=\"glyphicon glyphicon-bell\"></span>";
            }
            return "";
        }
    }
];

let table;

$(document).ready(function() {
    table = $('#requests-table').DataTable( {
            "processing": true,
            "serverSide": false,
            "ajax": {
              "url": "{% url 'pyha:get_request_list_ajax' %}",
              {% if role == "handler" or role == "admin" %}
              "data": function (d) {
                d.onlyUncompleted = $("#showOnlyUncompletedRequestsTrueBtn").prop("disabled");
              },
              {% endif %}
              "type": "GET",
              "headers": {"X-CSRFToken": "{{ csrf_token }}"},
              "error": function() {
                alert("{% trans "generic_error" %}");
                $("#requests-table_processing").hide();
              }
            },
            "columns": [
                {% if role == "admin" %}
                allColumns[0], allColumns[4], allColumns[5], allColumns[6], allColumns[7], allColumns[8], allColumns[9]
                {% elif role == "handler" %}
                allColumns[10], allColumns[0], allColumns[4], allColumns[5], allColumns[6], allColumns[7], allColumns[8]
                {% else %}
                allColumns[0], allColumns[1], allColumns[2], allColumns[3], allColumns[9]
                {% endif %}
            ],
			"order": [[ {% if role == "handler" %} 1 {% else %} 0 {% endif %}, "desc" ]],
            {% if role == "user" %}
            "columnDefs": [{ "width": "15%", "targets": 4 }],
            {% endif %}
            {% if role == "handler" or role == "admin" %}
            "lengthMenu": [[1, 10, 25, 50, 100, 500, 1000, 5000], [1, 10, 25, 50, 100, 500, 1000, 5000]],
            "pageLength": 100,
            {% endif %}
            "language": {
            {% if LANGUAGE == "fi" %}
            "url":"//cdn.datatables.net/plug-ins/1.10.12/i18n/Finnish.json"
            {% elif LANGUAGE == "sv" %}
            "url":"//cdn.datatables.net/plug-ins/1.10.12/i18n/Swedish.json"
            {% endif %}
            },
            "createdRow": function(row, data, dataIndex) {
                var className = "clickable-row indextr";
                if (data.status == 1) {
                    className += " info";
                } else if (data.status == 3 || data.status == -2) {
                    className += " danger";
                } else if (data.status == 2) {
                    className += " warning";
                } else if (data.status == 0 || data.status == 6) {
                    className += " active";
                } else if (data.status == 4 || data.status == 7 || data.status == 8) {
                    className += " success";
                }
                $(row).addClass(className);

                $(row).click(function(e) {
                    if (e.target && e.target.type === "checkbox") {
                        return;
                    }
                    if (e.target && e.target.classList.contains("checkbox-column")) {
                        e.target.children[0].click();
                        return;
                    }
                    window.document.location = "{% url 'pyha:root' %}request/" + data.id;
                });
            }
        } );
    } );

    function showOnlyUncompletedRequestsChange(value) {
        const trueBtn = $("#showOnlyUncompletedRequestsTrueBtn");
        const falseBtn = $("#showOnlyUncompletedRequestsFalseBtn");
        if (value) {
            trueBtn.prop("disabled", true);
            falseBtn.prop("disabled", false);
        } else {
            trueBtn.prop("disabled", false);
            falseBtn.prop("disabled", true);
        }
        if (table) {
            table.ajax.reload();
        }
    }
    showOnlyUncompletedRequestsChange(true);
</script>
{% endblock %}
